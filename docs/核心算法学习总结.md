# Uniswap Smart-Order-Router æ ¸å¿ƒç®—æ³•å­¦ä¹ æ€»ç»“

## ğŸ¯ å­¦ä¹ ç›®æ ‡å›é¡¾

é€šè¿‡æ·±å…¥åˆ†æ `@uniswap/smart-order-router` åŒ…çš„æºç ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä»¥ä¸‹å­¦ä¹ ç›®æ ‡ï¼š

âœ… **ç†è§£æ ¸å¿ƒæ¶æ„**: æŒæ¡äº† AlphaRouter çš„æ•´ä½“è®¾è®¡å’Œç»„ä»¶å…³ç³»  
âœ… **åˆ†æè·¯ç”±ç®—æ³•**: æ·±å…¥å­¦ä¹ äº†å¤šåè®®å¹¶è¡Œè·¯ç”±æŸ¥æ‰¾æœºåˆ¶  
âœ… **æŒæ¡ä¼˜åŒ–ç­–ç•¥**: ç†è§£äº† BFS æœ€ä½³è·¯ç”±é€‰æ‹©ç®—æ³•  
âœ… **å®è·µæŒ‡å—**: åˆ›å»ºäº†å®Œæ•´çš„è‡ªå®šä¹‰èšåˆå™¨å¼€å‘æŒ‡å—  

## ğŸ“‹ æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. AlphaRouter æ ¸å¿ƒæ¶æ„

#### ä¸»è¦ç»„ä»¶æ„æˆ
```typescript
class AlphaRouter {
  // æ ¸å¿ƒæä¾›è€…
  tokenProvider: ITokenProvider;
  v2PoolProvider: IV2PoolProvider;
  v3PoolProvider: IV3PoolProvider;
  v4PoolProvider: IV4PoolProvider;
  
  // æŠ¥ä»·å™¨
  v2Quoter: IV2Quoter;
  v3Quoter: IV3Quoter;
  v4Quoter: IV4Quoter;
  mixedQuoter: IMixedQuoter;
  
  // Gas æ¨¡å‹
  v2GasModel: IV2GasModel;
  v3GasModel: IV3GasModel;
  v4GasModel: IV4GasModel;
  
  // ç¼“å­˜å’Œå…¶ä»–æœåŠ¡
  routeCachingProvider: IRouteCachingProvider;
  tokenPropertiesProvider: ITokenPropertiesProvider;
  portionProvider: IPortionProvider;
}
```

#### æ ¸å¿ƒæ¥å£è®¾è®¡
- **IQuoter**: å„åè®®çš„æŠ¥ä»·æ¥å£ï¼Œç»Ÿä¸€äº† V2/V3/V4 çš„æŠ¥ä»·é€»è¾‘
- **IGasModel**: Gas ä¼°ç®—æ¥å£ï¼Œæ”¯æŒä¸åŒåè®®çš„ Gas è®¡ç®—
- **IPoolProvider**: æ± å­æ•°æ®æä¾›æ¥å£ï¼Œæ”¯æŒå¤šæ•°æ®æº
- **IRouteCachingProvider**: è·¯ç”±ç¼“å­˜æ¥å£ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½

### 2. æ ¸å¿ƒè·¯ç”±ç®—æ³•æµç¨‹

#### ä¸»è¦ç®—æ³•æ­¥éª¤
```mermaid
graph TD
    A[routeæ–¹æ³•å…¥å£] --> B[åˆå§‹åŒ–å’Œé¢„å¤„ç†]
    B --> C[æ£€æŸ¥ç¼“å­˜ç­–ç•¥]
    C --> D[å¹¶è¡Œè·å–å€™é€‰æ± ]
    D --> E[å¤šåè®®å¹¶è¡ŒæŠ¥ä»·]
    E --> F[æ··åˆè·¯ç”±å¤„ç†]
    F --> G[æœ€ä½³è·¯ç”±é€‰æ‹©]
    G --> H[ç»“æœå¤„ç†å’Œè¿”å›]
    
    D --> D1[V2å€™é€‰æ± ]
    D --> D2[V3å€™é€‰æ± ]
    D --> D3[V4å€™é€‰æ± ]
    
    E --> E1[V2Quoter]
    E --> E2[V3Quoter]
    E --> E3[V4Quoter]
    E --> E4[MixedQuoter]
```

#### å…³é”®ç®—æ³•ç‰¹æ€§
1. **å¹¶è¡Œå¤„ç†**: æ‰€æœ‰åè®®çš„æ± å­è·å–å’ŒæŠ¥ä»·è®¡ç®—éƒ½æ˜¯å¹¶è¡Œæ‰§è¡Œ
2. **æ™ºèƒ½ç¼“å­˜**: æ”¯æŒå¤šç§ç¼“å­˜æ¨¡å¼ï¼ˆLivemodeã€Darkmodeã€Tapcompareï¼‰
3. **Gas ä¼˜åŒ–**: è€ƒè™‘ L1+L2 Gas è´¹ç”¨çš„ç»¼åˆä¼˜åŒ–
4. **åè®®å…¼å®¹**: æ™ºèƒ½å¤„ç†ä¸åŒè·¯ç”±å™¨ç‰ˆæœ¬çš„åè®®æ”¯æŒ

### 3. æœ€ä½³è·¯ç”±é€‰æ‹©ç®—æ³•ï¼ˆBFSï¼‰

#### ç®—æ³•æ ¸å¿ƒæ€æƒ³
- **è·¯ç”±æ‹†åˆ†**: å°†å¤§é¢äº¤æ˜“æ‹†åˆ†ä¸ºå¤šä¸ªå°é¢äº¤æ˜“ä»¥è·å¾—æ›´å¥½ä»·æ ¼
- **å¹¿åº¦ä¼˜å…ˆæœç´¢**: ç³»ç»Ÿæ€§åœ°æ¢ç´¢æ‰€æœ‰å¯èƒ½çš„è·¯ç”±ç»„åˆ
- **æ± å­å»é‡**: é¿å…åœ¨åŒä¸€æ± å­ä¸­é‡å¤äº¤æ˜“ä»¥ä¿è¯æŠ¥ä»·å‡†ç¡®æ€§

#### ç®—æ³•å®ç°è¦ç‚¹
```typescript
// æ ¸å¿ƒ BFS å¾ªç¯
while (queue.size > 0) {
  let layer = queue.size;
  splits++;
  
  // æ—©æœŸç»ˆæ­¢æ¡ä»¶
  if (splits >= 3 && bestSwap && bestSwap.length < splits - 1) {
    break;
  }
  
  while (layer > 0) {
    const { remainingPercent, curRoutes, percentIndex } = queue.dequeue();
    
    for (let i = percentIndex; i >= 0; i--) {
      const percentA = percents[i];
      if (percentA > remainingPercent) continue;
      
      // æ‰¾åˆ°ä¸é‡ç”¨æ± å­çš„æœ€ä½³è·¯ç”±
      const routeWithQuoteA = findFirstRouteNotUsingUsedPools(
        curRoutes, candidateRoutesA, forceCrossProtocol
      );
      
      if (routeWithQuoteA) {
        const curRoutesNew = [...curRoutes, routeWithQuoteA];
        
        if (remainingPercentNew == 0 && splits >= minSplits) {
          // æ‰¾åˆ°å®Œæ•´è·¯ç”±ï¼Œæ›´æ–°æœ€ä½³ç»“æœ
          updateBestRoute(curRoutesNew);
        } else {
          // ç»§ç»­æœç´¢
          queue.enqueue({ curRoutes: curRoutesNew, ... });
        }
      }
    }
  }
}
```

### 4. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### ç¼“å­˜æœºåˆ¶
- **è·¯ç”±ç¼“å­˜**: ç¼“å­˜è®¡ç®—ç»“æœï¼Œæé«˜å“åº”é€Ÿåº¦
- **æ± å­ç¼“å­˜**: ç¼“å­˜æ± å­æ•°æ®ï¼Œå‡å°‘é“¾ä¸ŠæŸ¥è¯¢
- **Token ç¼“å­˜**: ç¼“å­˜ä»£å¸ä¿¡æ¯ï¼Œé¿å…é‡å¤è·å–

#### å¹¶è¡Œä¼˜åŒ–
- **å€™é€‰æ± å¹¶è¡Œè·å–**: åŒæ—¶ä»å¤šä¸ªåè®®è·å–å€™é€‰æ± 
- **æŠ¥ä»·å¹¶è¡Œè®¡ç®—**: å¹¶è¡Œè®¡ç®—å„åè®®çš„æŠ¥ä»·
- **Gas æ¨¡å‹å¹¶è¡Œ**: å¹¶è¡Œè®¡ç®—ä¸åŒåè®®çš„ Gas è´¹ç”¨

#### æœç´¢ä¼˜åŒ–
- **æ—©æœŸç»ˆæ­¢**: å½“å¢åŠ æ‹†åˆ†ä¸èƒ½æ”¹å–„ç»“æœæ—¶æå‰ç»ˆæ­¢
- **æœç´¢ç©ºé—´æ§åˆ¶**: é™åˆ¶æœ€å¤§æ‹†åˆ†æ•°é‡å’Œæœç´¢æ·±åº¦
- **å†…å­˜ç®¡ç†**: ä½¿ç”¨å›ºå®šå¤§å°çš„å †æ§åˆ¶å†…å­˜ä½¿ç”¨

## ğŸ› ï¸ è‡ªå®šä¹‰èšåˆå™¨å¼€å‘è¦ç‚¹

### 1. æ ¸å¿ƒæŠ€æœ¯æ ˆ
```json
{
  "dependencies": {
    "@uniswap/smart-order-router": "^4.22.20",
    "@uniswap/sdk-core": "^4.x",
    "@uniswap/v2-sdk": "^3.x",
    "@uniswap/v3-sdk": "^3.x",
    "@uniswap/router-sdk": "^1.x",
    "ethers": "^5.x"
  }
}
```

### 2. åŸºç¡€æ¶æ„å®ç°
```typescript
class MyAggregator {
  private router: AlphaRouter;
  private provider: JsonRpcProvider;
  
  constructor(config: AggregatorConfig) {
    this.provider = new JsonRpcProvider(config.rpcUrl);
    this.router = new AlphaRouter({
      chainId: config.chainId,
      provider: this.provider,
    });
  }
  
  async getQuote(tokenIn: Token, tokenOut: Token, amountIn: string) {
    const amount = CurrencyAmount.fromRawAmount(tokenIn, amountIn);
    const route = await this.router.route(amount, tokenOut, TradeType.EXACT_INPUT);
    return this.formatQuote(route);
  }
}
```

### 3. æ‰©å±•æœºä¼š
1. **åè®®æ‰©å±•**: æ·»åŠ å¯¹æ›´å¤š DEX åè®®çš„æ”¯æŒ
2. **è·¨é“¾æ”¯æŒ**: å®ç°è·¨é“¾æ¡¥æ¥åŠŸèƒ½
3. **é«˜çº§åŠŸèƒ½**: é™ä»·å•ã€DCAã€MEV ä¿æŠ¤ç­‰
4. **ç”¨æˆ·ç•Œé¢**: æ„å»º Web æˆ–ç§»åŠ¨ç«¯ç•Œé¢

## ğŸ“Š å®é™…åº”ç”¨åœºæ™¯

### 1. ä¸ªäººäº¤æ˜“å·¥å…·
- ä¸ºä¸ªäººç”¨æˆ·æä¾›æœ€ä¼˜äº¤æ˜“è·¯å¾„
- å‡å°‘æ»‘ç‚¹å’Œäº¤æ˜“æˆæœ¬
- æ”¯æŒæ‰¹é‡äº¤æ˜“æ“ä½œ

### 2. DeFi åè®®é›†æˆ
- ä¸ºå…¶ä»– DeFi åè®®æä¾›äº¤æ˜“åŠŸèƒ½
- ä½œä¸ºåŸºç¡€è®¾æ–½è¢«å…¶ä»–åº”ç”¨è°ƒç”¨
- å®ç°å¤æ‚çš„äº¤æ˜“ç­–ç•¥

### 3. å¥—åˆ©å’Œ MEV
- å‘ç°è·¨åè®®å¥—åˆ©æœºä¼š
- å®ç°è‡ªåŠ¨åŒ–å¥—åˆ©ç­–ç•¥
- MEV æœç´¢å’Œæå–

### 4. æµåŠ¨æ€§ç®¡ç†
- LP å¤´å¯¸ç®¡ç†å·¥å…·
- è‡ªåŠ¨å†å¹³è¡¡ç­–ç•¥
- æ”¶ç›Šä¼˜åŒ–ç®—æ³•

## ğŸ” æ·±å…¥å­¦ä¹ å»ºè®®

### 1. æºç æ·±å…¥ç ”ç©¶
- ç»§ç»­é˜…è¯» `getRoutesThenQuotes` æ–¹æ³•å®ç°
- ç ”ç©¶å„åè®® Quoter çš„å…·ä½“å®ç°
- å­¦ä¹  Gas æ¨¡å‹çš„è¯¦ç»†è®¡ç®—é€»è¾‘

### 2. å®è·µé¡¹ç›®
- ä»ç®€å•çš„æŠ¥ä»·åŠŸèƒ½å¼€å§‹
- é€æ­¥æ·»åŠ è·¯ç”±æ‹†åˆ†åŠŸèƒ½
- å®ç°è‡ªå®šä¹‰åè®®æ”¯æŒ

### 3. æ€§èƒ½ä¼˜åŒ–
- ç ”ç©¶ç¼“å­˜ç­–ç•¥çš„æœ€ä½³å®è·µ
- ä¼˜åŒ–ç½‘ç»œè¯·æ±‚å’Œå¹¶å‘å¤„ç†
- ç›‘æ§å’Œè°ƒä¼˜ç³»ç»Ÿæ€§èƒ½

### 4. ç”Ÿäº§éƒ¨ç½²
- å­¦ä¹  AWS åŸºç¡€è®¾æ–½æ­å»º
- å®ç°ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
- æŒæ¡è¿ç»´å’Œæ•…éšœå¤„ç†

## ğŸ“š ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Uniswap Documentation](https://docs.uniswap.org/)
- [Smart Order Router GitHub](https://github.com/Uniswap/smart-order-router)
- [Routing API GitHub](https://github.com/Uniswap/routing-api)

### æŠ€æœ¯æ–‡ç« 
- [Uniswap Labs Blog](https://blog.uniswap.org/)
- [Understanding AMM Mechanics](https://research.paradigm.xyz/)
- [MEV and DEX Aggregators](https://www.mev.wiki/)

### å¼€å‘å·¥å…·
- [Tenderly Simulation](https://tenderly.co/)
- [The Graph Protocol](https://thegraph.com/)
- [Infura/Alchemy RPC](https://infura.io/)

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

1. **âœ… å·²å®Œæˆ**: 
   - ç†è§£ Smart-Order-Router æ ¸å¿ƒæ¶æ„
   - åˆ†ææ ¸å¿ƒè·¯ç”±ç®—æ³•å®ç°
   - æŒæ¡æœ€ä½³è·¯ç”±é€‰æ‹©ç­–ç•¥
   - åˆ›å»ºè‡ªå®šä¹‰èšåˆå™¨å¼€å‘æŒ‡å—

2. **ğŸ”„ è¿›è¡Œä¸­**:
   - æ·±å…¥ç ”ç©¶å„åè®® Quoter å®ç°
   - åˆ†æ Gas æ¨¡å‹è®¡ç®—é€»è¾‘
   - å­¦ä¹ ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

3. **ğŸ“‹ å¾…å®Œæˆ**:
   - å®ç°å®Œæ•´çš„è‡ªå®šä¹‰èšåˆå™¨åŸå‹
   - æ·»åŠ å¯¹æ›´å¤š DEX åè®®çš„æ”¯æŒ
   - æ„å»ºç”¨æˆ·ç•Œé¢å’Œ API æœåŠ¡
   - éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå¹¶è¿›è¡Œæµ‹è¯•

é€šè¿‡è¿™æ¬¡æ·±å…¥çš„æºç åˆ†æï¼Œæˆ‘ä»¬å·²ç»å…·å¤‡äº†æ„å»ºè‡ªå®šä¹‰èšåˆå™¨çš„æ ¸å¿ƒæŠ€æœ¯åŸºç¡€ã€‚ç°åœ¨å¯ä»¥å¼€å§‹å®é™…çš„å¼€å‘å·¥ä½œï¼Œå°†ç†è®ºçŸ¥è¯†è½¬åŒ–ä¸ºå®é™…çš„ä»£ç å®ç°ï¼
